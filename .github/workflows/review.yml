# Nome do workflow do nosso rob√¥ revisor
name: Assistente de Revis√£o de PR

on:
  # Gatilho: Roda quando um Pull Request √© aberto ou sincronizado (novos commits)
  pull_request:
    types: [opened, synchronize]

jobs:
  analyze-pr:
    name: Analisar Altera√ß√µes do PR
    runs-on: ubuntu-latest
    steps:
      # 1. Faz o checkout do c√≥digo do PR para que possamos analis√°-lo
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          # Precisamos buscar o hist√≥rico para comparar as branches
          fetch-depth: 0

      # 2. Passo principal: Analisa as altera√ß√µes no arquivo index.html
      - name: Verificar se apenas linhas foram adicionadas ao index.html
        id: check_diff # Damos um ID a este passo para usar seu resultado depois
        run: |
          # Compara a branch do PR (HEAD) com a branch principal (main)
          # Foco apenas no arquivo index.html
          # O comando 'git diff' nos mostra as linhas adicionadas (+) e removidas (-)
          # Usamos 'grep' para filtrar essas linhas e 'wc -l' para cont√°-las.
          
          git diff --no-prefix origin/${{ github.base_ref }}..origin/${{ github.head_ref }} -- index.html > diff.txt
          
          ADDED_LINES=$(grep -c '^+ ' diff.txt || true)
          REMOVED_LINES=$(grep -c '^- ' diff.txt || true)
          
          echo "Linhas Adicionadas: $ADDED_LINES"
          echo "Linhas Removidas: $REMOVED_LINES"
          
          # A regra: s√≥ pode haver linhas adicionadas. Nenhuma pode ser removida.
          # A primeira linha de um diff √© sempre '--- a/...' que conta como removida, ent√£o permitimos 1 remo√ß√£o.
          if [[ "$REMOVED_LINES" -le 1 && "$ADDED_LINES" -gt 0 ]]; then
            echo "RESULT=success" >> $GITHUB_OUTPUT
          else
            echo "RESULT=failure" >> $GITHUB_OUTPUT
          fi

      # 3. Usa uma action para postar coment√°rios no PR
      - name: Postar coment√°rio de sucesso no PR
        # Roda apenas se o passo anterior (check_diff) teve o resultado "success"
        if: steps.check_diff.outputs.RESULT == 'success'
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            Ol√°, @${{ github.actor }}! üëã
            
            Obrigado pela sua contribui√ß√£o! Nosso rob√¥ revisor verificou seu Pull Request e parece que est√° tudo certo: voc√™ apenas adicionou seu card ao mural.
            
            Excelente trabalho! ‚úÖ
            
            Agora, um mantenedor humano far√° a revis√£o final.

      - name: Postar coment√°rio de falha no PR
        # Roda apenas se o passo anterior (check_diff) teve o resultado "failure"
        if: steps.check_diff.outputs.RESULT == 'failure'
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            Ol√°, @${{ github.actor }}! üëã
            
            Obrigado por iniciar esta contribui√ß√£o! Nosso rob√¥ revisor analisou seu Pull Request e detectou um problema.
            
            üî¥ **Problema:** Parece que voc√™ modificou ou removeu linhas do `index.html` em vez de apenas adicionar o seu card.
            
            Por favor, ajuste seu c√≥digo para garantir que voc√™ est√° **apenas adicionando** o seu card, sem alterar o conte√∫do que j√° existe. Se tiver d√∫vidas, consulte nosso [Guia de Contribui√ß√£o](https://github.com/brenohp/mural-de-aprendizagem/blob/main/CONTRIBUTING.md) ou pe√ßa ajuda aqui nos coment√°rios.